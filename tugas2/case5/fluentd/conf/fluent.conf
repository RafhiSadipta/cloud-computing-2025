<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Only pass lines that look like nginx access logs to the parser
<filter nginx.**>
  @type grep
  <regexp>
    key log
    pattern /^\d+\.\d+\.\d+\.\d+ - / 
  </regexp>
</filter>

<filter nginx.**>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type regexp
    expression /^(?<remote>\S+) - (?<user>\S+) \[(?<time>[^\]]+)\] "(?<method>\S+) (?<path>[^\"]*) (?<protocol>[^\"]*)" (?<code>\d{3}) (?<size>\d+)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)"(?: "(?<xff>[^\"]*)")?)?$/
    time_format %d/%b/%Y:%H:%M:%S %z
  </parse>
</filter>

<match nginx.**>
  @type copy
  
  <store>
    @type stdout
    <format>
      @type json
    </format>
  </store>
  
  <store>
    @type file
    path /fluentd/log/nginx-access.log
    append true
    
    <format>
      @type single_value
      message_key log
    </format>
    
    <buffer>
      @type file
      path /fluentd/log/buffer/nginx
      flush_mode interval
      flush_interval 1s
      chunk_limit_size 5M
    </buffer>
  </store>
</match>
